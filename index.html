<!DOCTYPE html>
<html>

<head>
    <title>3D Maps with Street View</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map-container {
            height: 100%;
            width: 70%;
            float: left;
        }

        #street-view-container {
            height: 100%;
            width: 30%;
            float: left;
        }

        #search-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1;
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #address-input {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            font-size: 16px;
            border-radius: 20px;
            background-color: transparent;
        }

        #search-button {
            background-color: transparent;
            border: none;
            padding: 10px;
            cursor: pointer;
            transition: color 0.3s;
        }

        #search-button i {
            font-size: 20px;
            color: #333;
        }

        #search-button:hover {
            color: #007bff;
        }

        #info-window {
            position: absolute;
            top: 80px;
            left: 20px;
            z-index: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }
    </style>
</head>

<body>
    <div id="search-box">
        <input id="address-input" type="text" placeholder="Enter an address" />
        <button id="search-button"><i class="fas fa-search"></i></button>
    </div>
    <div id="info-window">
        <p><strong>Address:</strong> <span id="address-detail"></span></p>
        <p><strong>Latitude:</strong> <span id="latitude"></span></p>
        <p><strong>Longitude:</strong> <span id="longitude"></span></p>
        <p><strong>distance:</strong> <span id="distance"></span></p>
    </div>
    <div id="map-container"></div>
    <div id="street-view-container"></div>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIDtLk1Z5XvyoBBgatUfVqMDqocaLrcW8&v=alpha&libraries=maps3d,maps,places"></script>

    <script>
        async function init() {
            const { Map3DElement, Marker3DElement } = google.maps.maps3d;
            const { Autocomplete } = google.maps.places;
            let userPosition = null;

            // 获取用户当前位置
            function getUserPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                        () => reject(new Error("Unable to get user position"))
                    );
                });
            }

            // 计算两点之间的距离
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // 地球半径，单位为公里
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; // 返回距离，单位为公里
            }

            getUserPosition().then((position) => {
                userPosition = position;
                const map3DElement = new Map3DElement({
                    center: { lat: userPosition.lat, lng: userPosition.lng, altitude: 400 },
                    range: 1000,
                    tilt: 60,
                });
                console.log(map3DElement)

                document.getElementById('map-container').append(map3DElement);
                // 更新街景视图
                const streetView = new google.maps.StreetViewPanorama(
                    document.getElementById('street-view-container'), {
                    position: { lat:userPosition.lat, lng:userPosition.lng },
                    pov: {
                        heading: 34,
                        pitch: 10
                    },
                    zoom: 1
                });
                console.log(streetView)
                map3DElement.addEventListener('gmp-click', (event) => {
                            console.log(event);
                            // Do something with event.position.
                            streetView.setPosition(event.position)
                        });
                const input = document.getElementById('address-input');
                const autocomplete = new Autocomplete(input);

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.geometry && place.geometry.location) {
                        const lat = place.geometry.location.lat();
                        const lng = place.geometry.location.lng();
                        const address = place.formatted_address;

                        // 更新地图中心
                        map3DElement.center = { lat, lng, altitude: 400 };

                        // 添加标记
                        const pinScaled = new google.maps.Marker({
                            scale: 1.5,
                        });
                        const markerWithScale = new Marker3DElement({
                            position: { lat: lat, lng: lng },
                        });
                        markerWithScale.append(pinScaled);
                        map3DElement.append(markerWithScale);

                        // 计算距离
                        const distance = calculateDistance(userPosition.lat, userPosition.lng, lat, lng).toFixed(2);


                       
                        // 显示信息窗口
                        const infoWindow = document.getElementById('info-window');
                        infoWindow.style.display = 'block';
                        document.getElementById('address-detail').innerText = address;
                        document.getElementById('latitude').innerText = lat.toFixed(6);
                        document.getElementById('longitude').innerText = lng.toFixed(6);
                        document.getElementById('distance').innerText = distance+"km";
                        const pop = new google.maps.InfoWindow({
                            content: infoWindow
                        });
                        pop.open({
                                anchor: markerWithScale,
                                map3DElement,
                            });
                    }
                });

            }).catch((error) => {
                console.error(error);
            });
        }

        init();
    </script>
</body>

</html>